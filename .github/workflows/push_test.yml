name: DAB Validation and Testing

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
  push:
    branches: [main, feature/github_action]

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    environment: dev
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'
    
    - name: Install Databricks CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
    
    - name: Validate DAB Bundle
      run: |
        databricks bundle validate -t dev
    
    - name: Deploy to Dev Environment
      run: |
        databricks bundle deploy -t dev
    
    - name: Run Test Job
      id: test_job
      run: |
        # Run the Test job and capture the run ID
        RUN_OUTPUT=$(databricks bundle run Test -t dev)
        
        # Check if "All tests passed" is in the output
        if echo "$RUN_OUTPUT" | grep -q "All tests passed"; then
          echo "Tests passed successfully."
        else
          echo "Tests failed."
          exit 1
        fi

    - name: Run Local Inference Test
      run: |
        pytest tests/test_mlflow_model_loading.py
        # Check if all test are passed
        if [ $? -ne 0 ]; then
          echo "Local inference tests failed."
          exit 1
        else
          echo "Local inference tests passed successfully."
        fi