name: DAB Validation and Testing

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
  push:
    branches: [main, feature/github_action]

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    environment: dev
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'
    
    - name: Install Databricks CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
    
    - name: Validate DAB Bundle
      run: |
        databricks bundle validate -t dev
    
    - name: Deploy to Dev Environment
      run: |
        databricks bundle deploy -t dev
    
    - name: Run Test Job
      id: test_job
      run: |
        # Run the Test job and capture the run ID
        RUN_OUTPUT=$(databricks bundle run Test -t dev)
        RUN_ID=$(echo "$RUN_OUTPUT" | grep -oP 'Run URL:.*runs/\K[0-9]+' || echo "$RUN_OUTPUT" | grep -oP 'run_id":\s*\K[0-9]+')
        echo "test_run_id=$RUN_ID" >> $GITHUB_OUTPUT
        
        # Wait for completion and check status
        databricks runs wait $RUN_ID --timeout 30m
        
        # Get final state
        STATE=$(databricks runs get $RUN_ID --output json | jq -r '.state.life_cycle_state')
        RESULT=$(databricks runs get $RUN_ID --output json | jq -r '.state.result_state')
        
        if [ "$RESULT" != "SUCCESS" ]; then
          echo "Test job failed with result: $RESULT"
          exit 1
        fi